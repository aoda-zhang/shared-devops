name: Delivery pipline

on:
  workflow_call:
    secrets:
      PAT:
        required: true
        description: "Personal Access Token"

    # Azure options --------------------------------
      AZURE_ACR_SERVER:
        required: true
        description: "azure acr server"

      AZURE_ACR_USERNAME:
        required: true
        description: "azure acr username"

      AZURE_ACR_PASSWORD:
        required: true
        description: "azure acr password"

    inputs:
      # PAT:
      #   required: true
      #   type: string

      # AZURE_ACR_SERVER:
      #   required: true
      #   type: string

      # AZURE_ACR_USERNAME:
      #   required: true
      #   type: string

      # AZURE_ACR_PASSWORD:
      #   required: true
      #   type: string

      app_repository:
        required: true
        type: string

      app_branch:
        required: true
        type: string

      # For disfferent microservice project path in monorepo
      deployed_app:
        required: true
        type: string

      # For disfferent microservice project path in monorepo
      deploye_type:
        required: true
        type: string
        default: WEB

      config_path:
        required: true
        type: string

      # Build artifact options--------------------------------

      build_path:
        required: false
        type: string
        default: build

      # the docker file path
      dockerFile_path:
        required: false
        type: string
        default: Dockerfile

      # the environment that u want to deploy (uat,test,prod)
      currentEnvironment:
        required: false
        type: string
        default: uat

jobs:
  Inject-deployment-variables:
    runs-on: ubuntu-latest
    steps:
      - name: Set outputs for deployment
        id: payload
        run: |
          echo "::set-output name=deployedRepository::${{ inputs.app_repository }}"
          echo "::set-output name=deployedAppBranch::${{ inputs.app_branch }}"
          echo "::set-output name=deployedApp::${{ inputs.deployed_app }}"
          echo "::set-output name=configPath::${{ inputs.config_path }}"
          echo "::set-output name=deployedEnv::${{ inputs.environment || 'uat' }}"

  Prepare-deployment-summary:
    needs: [Inject-deployment-variables]
    runs-on: ubuntu-latest
    steps:
      - name: summary
        run: |
          echo "-----------  Deployment Summary ----------------"
          echo "The deploy app/service is : ${{ needs.Inject-deployment-variables.outputs.deployedApp }}"
          echo "The repositry is : ${{ needs.Inject-deployment-variables.outputs.deployedRepository }}"
          echo "The app/service branch is : ${{ needs.Inject-deployment-variables.outputs.deployedAppBranch }}" 
          echo "The deployed app config folder Path is : ${{ needs.Inject-deployment-variables.outputs.configPath }}"
          echo "Current deployed environment is: ${{ needs.Inject-deployment-variables.outputs.deployedEnv }}"
          echo "----------- Please check the summary when troubleshooting ----------------"

  Project-prepare:
    needs: [Inject-deployment-variables]
    uses: ./.github/workflows/shared_project_prepare.yaml
    with:
      app_repository: ${{ needs.Inject-deployment-variables.outputs.deployedRepository }}
      app_branch: ${{ needs.Inject-deployment-variables.outputs.deployedAppBranch }}
      deployed_app: ${{ needs.Inject-deployment-variables.outputs.deployedApp }}
      config_folder: ${{ needs.Inject-deployment-variables.outputs.configPath }}
      currentEnvironment: ${{ needs.Inject-deployment-variables.outputs.deployedEnv }}
    secrets:
      PAT: ${{ secrets.PAT }}

  Build-push-image:
    needs: [Inject-deployment-variables, Project-prepare]
    uses: ./.github/workflows/shared_image_build.yaml
    with:
      app_branch: ${{ github.ref }}
      deployed_app: ${{ needs.Inject-deployment-variables.outputs.deployedApp }}
      currentEnvironment: ${{ needs.Inject-deployment-variables.outputs.deployedEnv }}
    secrets:
      AZURE_ACR_SERVER: ${{ secrets.AZURE_ACR_SERVER }}
      AZURE_ACR_USERNAME: ${{ secrets.AZURE_ACR_USERNAME }}
      AZURE_ACR_PASSWORD: ${{ secrets.AZURE_ACR_PASSWORD }}
